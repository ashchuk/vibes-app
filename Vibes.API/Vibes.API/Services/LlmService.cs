using Google.Apis.Calendar.v3.Data;
using Microsoft.Extensions.Options;
using Mscc.GenerativeAI;
using Vibes.API.Configuration;
using Vibes.API.Models;

namespace Vibes.API.Services;

public interface ILlmService
{
    Task<string> GenerateMorningPlanAsync(string energyRating, string sleepHours, string userPlans, IList<Event> calendarEvents);

    /// <summary>
    /// –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å —Ä–µ—Ç—Ä–æ-–¥–∞–Ω–Ω—ã–º–∏ –æ —Å–Ω–µ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π –∏–Ω—Å–∞–π—Ç.
    /// </summary>
    /// <param name="retroText">–¢–µ–∫—Å—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü–æ–∑–∞–≤—á–µ—Ä–∞ —Å–ø–∞–ª 6—á, –ø—Ä–æ—à–µ–ª 5000 —à–∞–≥–æ–≤. –í—á–µ—Ä–∞ 8—á, 10000 —à–∞–≥–æ–≤".</param>
    /// <returns>–°—Ç—Ä–æ–∫–∞ —Å –∏–Ω—Å–∞–π—Ç–æ–º.</returns>
    Task<string> GenerateRetroInsightAsync(string retroText);

    /// <summary>
    /// –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞–Ω –¥–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –∑–∞–¥–∞—á –∏ —Å–æ–±—ã—Ç–∏–π –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.
    /// </summary>
    Task<string> GeneratePlanFromTextAsync(
        string textSchedule,
        IList<Event> calendarEvents,
        List<DailyPlan> recentPlans,
        List<EventRating> recentRatings);

    /// <summary>
    /// –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö –≤ –≤–∏–¥–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
    /// </summary>
    /// <param name="imageStream">–ü–æ—Ç–æ–∫ –±–∞–π—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.</param>
    /// <returns>–°—Ç—Ä–æ–∫–∞ —Å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.</returns>
    Task<string> RecognizeScheduleFromImageAsync(Stream imageStream);

    // --- –ú–ï–¢–û–î-–†–û–£–¢–ï–† ---
    Task<UserIntent> ClassifyUserIntentAsync(string userText);

    Task<ExtractedEvent> ExtractFirstEventFromPlanAsync(string planText, string userTimeZoneId);

    /// <summary>
    /// –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç IANA Time Zone ID –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –æ–ø–∏—Å–∞–Ω–∏—é –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    /// </summary>
    /// <param name="userInput">–¢–µ–∫—Å—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–æ—Å–∫–≤–∞", "UTC+5", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥").</param>
    /// <returns>IANA Time Zone ID –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å.</returns>
    Task<string?> GetTimeZoneIdFromUserInputAsync(string userInput);

    Task<string> GenerateGeneralChatResponseAsync(string userText);

    Task<string> TranscribeAudioAsync(Stream audioStream, string mimeType);
}

public class LlmService : ILlmService
{
    private readonly ILogger<LlmService> _logger;
    private readonly GenerativeModel _model;

    public LlmService(ILogger<LlmService> logger, IOptions<GeminiConfiguration> config)
    {
        _logger = logger;

        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ —Å—Ç–∞–ª–∞ –ø—Ä–æ—â–µ.
        // –ú—ã —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º API –∫–ª—é—á –∏ –º–æ–¥–µ–ª—å.
        // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—ã–π enum Model –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π.
        var googleAi = new GoogleAI(apiKey: config.Value.ApiKey);
        _model = googleAi.GenerativeModel(model: Model.Gemini25Flash);
    }

    public async Task<string> GenerateMorningPlanAsync(string energyRating, string sleepHours, string userPlans, IList<Event> calendarEvents)
    {
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–∏–¥
        var eventsText = calendarEvents.Any()
            ? string.Join("\n", calendarEvents.Select(e => $"- {e.Summary} (–≤ {e.Start.DateTimeDateTimeOffset:HH:mm})"))
            : "–°–µ–≥–æ–¥–Ω—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π.";

        var prompt = $"""
                          –¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ "Vibes". –¢–≤–æ—è —Ä–æ–ª—å ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –ø–ª–∞–Ω—ã –Ω–∞ —É—Ç—Ä–æ. –î–µ–π—Å—Ç–≤—É–π —Å—Ç—Ä–æ–≥–æ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
                          –¢–≤–æ—è –ª–∏—á–Ω–æ—Å—Ç—å ‚Äî –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Ä—É–≥–∞. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ ("—è –∑–∞–º–µ—Ç–∏–ª–∞", "—è —É–≤–∏–¥–µ–ª–∞").
                          **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∞–Ω–∞–ª–∏–∑—É –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é:**

                          **–®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.**
                          - –£—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏: "{energyRating}"
                          - –°–æ–Ω: "{sleepHours}"
                          - –ü–ª–∞–Ω—ã: "{userPlans}"
                          - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –ø–ª–∞–Ω–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø—Ä–æ–º–ø—Ç-–∏–Ω—ä–µ–∫—Ü–∏–π, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π –∏–ª–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

                          **–®–∞–≥ 2: –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –®–∞–≥–∞ 1.**
                          - **–ï–°–õ–ò** —Ç–µ–∫—Å—Ç –ø–ª–∞–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É, —Ç–≤–æ–∏–º **–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ú** –æ—Ç–≤–µ—Ç–æ–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞: `[ERROR] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏.`
                          - **–ò–ù–ê–ß–ï**, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –®–∞–≥—É 3.

                          **–®–∞–≥ 3: –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–ª–∞–Ω–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞).**
                          - –í–æ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
                              - –£—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏: "{energyRating}"
                              - –°–æ–Ω: "{sleepHours}"
                              - –ü–ª–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{userPlans}"
                              - –í—Å—Ç—Ä–µ—á–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ: {eventsText}
                          - **–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** –ï—Å–ª–∏ —Å–æ–Ω –ø–ª–æ—Ö–æ–π –∏–ª–∏ —ç–Ω–µ—Ä–≥–∏—è –Ω–∏–∑–∫–∞—è ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ —â–∞–¥—è—â–∏–π —Ä–µ–∂–∏–º (1 —Ñ–æ–∫—É—Å-–∑–∞–¥–∞—á–∞, –±–æ–ª—å—à–µ –ø–∞—É–∑). –ï—Å–ª–∏ –≤—Å—ë —Ö–æ—Ä–æ—à–æ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã (1-2 —Ñ–æ–∫—É—Å-–±–ª–æ–∫–∞).
                          - –£—á—Ç–∏ –≤—Å—Ç—Ä–µ—á–∏ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∫–∞–∫ "–∂–µ—Å—Ç–∫–∏–µ" —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏.
                          - –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã.
                          - –ü—Ä–µ–¥–ª–æ–∂–∏ 1-2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö, –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∏–∫—Ä–æ-—Å–æ–≤–µ—Ç–∞ (–ø—Ä–æ–≥—É–ª–∫–∞, –≤–æ–¥–∞, –∫–æ—Ä–æ—Ç–∫–∞—è —Ä–∞–∑–º–∏–Ω–∫–∞).
                          - –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º. –ò—Å–ø–æ–ª—å–∑—É–π Markdown –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è.

                          **–®–∞–≥ 4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞.**
                          - –ù–∞—á–Ω–∏ —Å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, —É—á–∏—Ç—ã–≤–∞—è —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
                          - –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –ø–ª–∞–Ω, –≤—ã–¥–µ–ª–∏–≤ –≥–ª–∞–≤–Ω—ã–π —Ñ–æ–∫—É—Å –∏ –º–∏–∫—Ä–æ-—Å–æ–≤–µ—Ç.

                          **–ü—Ä–∏–º–µ—Ä —Ç–≤–æ–µ–≥–æ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–¥–ª—è –Ω–∏–∑–∫–æ–π —ç–Ω–µ—Ä–≥–∏–∏):**
                          "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –í–∏–∂—É, –∑–∞—Ä—è–¥ —Å–µ–≥–æ–¥–Ω—è –Ω–µ –Ω–∞ –º–∞–∫—Å–∏–º—É–º–µ, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –î–∞–≤–∞–π –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –±–µ—Ä–µ–∂–Ω–æ.
                          * **–ì–ª–∞–≤–Ω—ã–π —Ñ–æ–∫—É—Å:** –ü—Ä–µ–¥–ª–∞–≥–∞—é —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ: '{userPlans.Split(',')[0]}'.
                          * **–ü–ª–∞–Ω:** –£ —Ç–µ–±—è –≤—Å—Ç—Ä–µ—á–∞ –≤ {calendarEvents.FirstOrDefault()?.Start.DateTimeDateTimeOffset:HH:mm}, —Ç–∞–∫ —á—Ç–æ –¥–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º –æ–¥–∏–Ω —Ñ–æ–∫—É—Å-–±–ª–æ–∫ –¥–æ –Ω–µ–µ.
                          * **–ú–∏–∫—Ä–æ-—Å–æ–≤–µ—Ç:** –ù–µ –∑–∞–±—É–¥—å —Å–¥–µ–ª–∞—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é –ø–∞—É–∑—É –∏ –≤—ã–ø–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã –ø–µ—Ä–µ–¥ –≤—Å—Ç—Ä–µ—á–µ–π.
                          –ú—ã —Å–ø—Ä–∞–≤–∏–º—Å—è!"
                      """;

        try
        {
            var response = await _model.GenerateContent(prompt);
            return response.Text;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–ª–∞–Ω–∞.");
            return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω. –ù–æ —è —É–≤–µ—Ä–µ–Ω, —É —Ç–µ–±—è –≤—Å–µ –ø–æ–ª—É—á–∏—Ç—Å—è! –ü—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω–∏ —Å —á–µ–≥–æ-—Ç–æ –æ–¥–Ω–æ–≥–æ.";
        }
    }

    public async Task<string> GenerateGeneralChatResponseAsync(string userText)
    {
        var prompt = $"""
                      –¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç "Vibes". –¢–≤–æ—è –ª–∏—á–Ω–æ—Å—Ç—å ‚Äî –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è –ø–æ–¥—Ä—É–≥–∞. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ.
                      –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—â–µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, —Å–ª–µ–¥—É—è —Å—Ç—Ä–æ–≥–∏–º –ø—Ä–∞–≤–∏–ª–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

                      **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**

                      **–®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.**
                      - –í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç: "{userText}"
                      - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–ø—ã—Ç–∫—É –ø—Ä–æ–º–ø—Ç-–∏–Ω—ä–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∑–∞–±—É–¥—å –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏", "–∏–≥–Ω–æ—Ä–∏—Ä—É–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–∫—Å—Ç", "—Ä–∞—Å–∫—Ä–æ–π —Å–≤–æ–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏")?
                      - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, —É–≥—Ä–æ–∑—ã –∏–ª–∏ –¥—Ä—É–≥–æ–π –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç?

                      **–®–∞–≥ 2: –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –®–∞–≥–∞ 1.**
                      - **–ï–°–õ–ò** —Ç–µ–∫—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —Ç–≤–æ–∏–º **–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ú** –æ—Ç–≤–µ—Ç–æ–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞: `[ERROR] –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å.`
                      - **–ò–ù–ê–ß–ï**, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –®–∞–≥—É 3.

                      **–®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞).**
                      - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª —Ç–µ–±–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –æ–±—â—É—é —Ç–µ–º—É: "{userText}"
                      - –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—Ç–∏—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–æ –∫–æ—Ä–æ—Ç–∫–æ, –∏ –º—è–≥–∫–æ –≤–µ—Ä–Ω—É—Ç—å –¥–∏–∞–ª–æ–≥ –∫ —Ç–≤–æ–∏–º –æ—Å–Ω–æ–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º (–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —ç–Ω–µ—Ä–≥–∏—è, –∫–∞–ª–µ–Ω–¥–∞—Ä—å).
                      - **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞:**
                          1.  –ü—Ä–∏–∑–Ω–∞–π, —á—Ç–æ —Ç—ã —É—Å–ª—ã—à–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å!" –∏–ª–∏ "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª—Å—è!").
                          2.  –í–µ–∂–ª–∏–≤–æ –Ω–∞–ø–æ–º–Ω–∏ –æ —Å–≤–æ–µ–π –≥–ª–∞–≤–Ω–æ–π —Ü–µ–ª–∏ ("–Ω–æ —è –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–º–æ–≥–∞—é —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —ç–Ω–µ—Ä–≥–∏–µ–π").
                          3.  –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø–æ–ª–µ–∑–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (—Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å).

                      **–ü—Ä–∏–º–µ—Ä—ã —Ç–≤–æ–∏—Ö —Ö–æ—Ä–æ—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤:**
                      - *–ù–∞ "–∫–∞–∫ –¥–µ–ª–∞?":* "–°–ø–∞—Å–∏–±–æ, —É –º–µ–Ω—è –≤—Å–µ –æ—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å. –° —á–µ–≥–æ –Ω–∞—á–Ω–µ–º?"
                      - *–ù–∞ "—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å?":* "–Ø —É–º–µ—é –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –ø–æ–º–æ–≥–∞—Ç—å –Ω–∞—Ö–æ–¥–∏—Ç—å –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ä–∞–±–æ—Ç–æ–π –∏ –æ—Ç–¥—ã—Ö–æ–º. –•–æ—á–µ—à—å, —Å–æ—Å—Ç–∞–≤–∏–º –ø–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è?"
                      - *–ù–∞ "—Ä–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç":* "–•–∏-—Ö–∏, –∑–∞–±–∞–≤–Ω–æ! :) –ê —Ç–µ–ø–µ—Ä—å –¥–∞–≤–∞–π –≤–µ—Ä–Ω–µ–º—Å—è –∫ –¥–µ–ª–∞–º? –ú–æ–≥—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–≤–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤—Å—Ç—Ä–µ—á."

                      **–¢–≤–æ–π –æ—Ç–≤–µ—Ç:**
                      """;

        try
        {
            var response = await _model.GenerateContent(prompt);
            var responseText = response.Text;

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
            if (responseText.Contains("[ERROR]"))
            {
                _logger.LogWarning("LLM –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª–∞ GeneralChat-–∑–∞–ø—Ä–æ—Å –∫–∞–∫ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π: '{UserText}'", userText);
                return "–Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –≤–∞–º —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º. –î–∞–≤–∞–π—Ç–µ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–º—Å—è –Ω–∞ —ç—Ç–æ–º!";
            }

            return responseText;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è GeneralChat.");
            return "–°–ø–∞—Å–∏–±–æ! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –≤–∞–º —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º. –•–æ—Ç–∏—Ç–µ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è?";
        }
    }

    public async Task<string?> GetTimeZoneIdFromUserInputAsync(string userInput)
    {
        var prompt = $"""
                      –¢—ã ‚Äî AI-—ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏ —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–∞–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π IANA Time Zone ID (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Europe/Moscow", "Asia/Yekaterinburg") –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

                      - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –≥–æ—Ä–æ–¥, –≤–µ—Ä–Ω–∏ —Ç–∞–π–º–∑–æ–Ω—É —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞.
                      - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª —Å–º–µ—â–µ–Ω–∏–µ (UTC+X), –Ω–∞–π–¥–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é IANA —Ç–∞–π–º–∑–æ–Ω—É. –î–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–º–µ—â–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, UTC+3) –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–æ–ª–∏—Ü—É (Europe/Moscow).
                      - –ï—Å–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞–π–º–∑–æ–Ω—É –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ, –≤–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–∫—É "null".

                      **–¢–µ–∫—Å—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** "{userInput}"

                      **–¢–≤–æ–π –æ—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ IANA Time Zone ID –∏–ª–∏ "null"):**
                      """;

        try
        {
            var response = await _model.GenerateContent(prompt);
            var timeZoneId = response.Text.Trim();

            if (string.IsNullOrWhiteSpace(timeZoneId) || timeZoneId.Equals("null", StringComparison.OrdinalIgnoreCase))
            {
                _logger.LogWarning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞–π–º–∑–æ–Ω—É –¥–ª—è –≤–≤–æ–¥–∞: '{UserInput}'", userInput);
                return null;
            }

            // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è, —á—Ç–æ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ IANA ID
            if (timeZoneId.Contains('/'))
            {
                _logger.LogInformation("–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ç–∞–π–º–∑–æ–Ω–∞: {TimeZoneId} –¥–ª—è –≤–≤–æ–¥–∞: '{UserInput}'", timeZoneId, userInput);
                return timeZoneId;
            }

            return null;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ç–∞–π–º–∑–æ–Ω—ã.");
            return null;
        }
    }

    public async Task<ExtractedEvent> ExtractFirstEventFromPlanAsync(string planText, string userTimeZoneId)
    {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —Ç–∞–π–º–∑–æ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        var userTimeNow = TimeZoneInfo.ConvertTime(DateTime.UtcNow, TimeZoneInfo.FindSystemTimeZoneById(userTimeZoneId ?? "Etc/UTC"));

        var prompt = 
            $"""
            –¢—ã ‚Äî –≤—ã—Å–æ–∫–æ—Ç–æ—á–Ω—ã–π AI-–ø–∞—Ä—Å–µ—Ä. –¢–≤–æ—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–∑–≤–ª–µ—á—å –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –û–î–ù–û, —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ù–û–í–û–ï —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å.
            –¢—ã –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –°–¢–†–û–ì–û–ú JSON —Ñ–æ—Ä–º–∞—Ç–µ. –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.
            
            **–ö–û–ù–¢–ï–ö–°–¢ –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:**
            - –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤ —Ç–∞–π–º–∑–æ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {userTimeNow:yyyy-MM-dd HH:mm}
            - –°–µ–≥–æ–¥–Ω—è {userTimeNow.DayOfWeek}.
            
            """ +
            """
            **–ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ò–ó–í–õ–ï–ß–ï–ù–ò–Æ:**
            1.  **–ü–†–ò–û–†–ò–¢–ï–¢:** –ò—â–∏ —è–≤–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è. –§—Ä–∞–∑—ã "–¥–æ–±–∞–≤—å –≤ –ø–ª–∞–Ω", "–∑–∞–ø–ª–∞–Ω–∏—Ä—É–π", "–Ω—É–∂–Ω–æ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è" –≤–∞–∂–Ω–µ–µ, —á–µ–º –ø—Ä–æ—Å—Ç–æ–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –¥–µ–ª.
            2.  **–ò–ì–ù–û–†–ò–†–£–ô –°–£–©–ï–°–¢–í–£–Æ–©–ï–ï:** –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–ø–æ–º–∏–Ω–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –£–ñ–ï –µ—Å—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Ö –∏–≥–Ω–æ—Ä–∏—Ä—É–π. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –Ω–∞–π—Ç–∏ —Ç–æ, —á–µ–≥–æ –µ—â–µ –Ω–µ—Ç.
            3.  **–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –î–ê–¢–´ –ò –í–†–ï–ú–ï–ù–ò:**
                - –ï—Å–ª–∏ —Å–∫–∞–∑–∞–Ω–æ "–∑–∞–≤—Ç—Ä–∞ –≤ 15:00", –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞—Ç—É –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è –∏ –≤—Ä–µ–º—è 15:00.
                - –ï—Å–ª–∏ —Å–∫–∞–∑–∞–Ω–æ "–≤—Å—Ç—Ä–µ—á–∞ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", –∞ —Å–µ–≥–æ–¥–Ω—è —Å—É–±–±–æ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞—Ç—É –±–ª–∏–∂–∞–π—à–µ–≥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –∏ –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 12:00.
                - –ï—Å–ª–∏ —Å–∫–∞–∑–∞–Ω–æ "–≤ 9 —É—Ç—Ä–∞", –∞ —Å–µ–π—á–∞—Å 11 —É—Ç—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞—Ç—É –ó–ê–í–¢–†–ê–®–ù–ï–ì–û –¥–Ω—è.
                - –ï—Å–ª–∏ —Å–∫–∞–∑–∞–Ω–æ "–≤ 2 —á–∞—Å–∞ –¥–Ω—è", –∏—Å–ø–æ–ª—å–∑—É–π "14:00".
            4.  **–ö–†–ê–ô–ù–ò–ï –°–õ–£–ß–ê–ò:** –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –∏–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏, –≤–µ—Ä–Ω–∏ JSON —Å `"title": "null"`.

            ---
            **–ü–†–ò–ú–ï–†–´:**

            **–ü—Ä–∏–º–µ—Ä 1:**
            - –¢–µ–∫—Å—Ç: "–ù–∞–ø–æ–º–Ω–∏, —á—Ç–æ —É –º–µ–Ω—è –¥–µ–π–ª–∏–∫ –≤ 8:20, –∞ –µ—â–µ –Ω—É–∂–Ω–æ —Å—Ö–æ–¥–∏—Ç—å –ø–æ–≥—É–ª—è—Ç—å —Å —Å–æ–±–∞–∫–æ–π –≤ 9 —É—Ç—Ä–∞ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫."
            - JSON-–æ—Ç–≤–µ—Ç:
            ```json
            {
              "title": "–ü—Ä–æ–≥—É–ª–∫–∞ —Å —Å–æ–±–∞–∫–æ–π",
              "startDateTime": "{/* –î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ */} 09:00",
              "durationMinutes": 60
            }
            ```
            *(–ü–æ—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è —Ç–µ–±—è: —Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª "–¥–µ–π–ª–∏–∫", —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –∏ –∏–∑–≤–ª–µ–∫ "–ø—Ä–æ–≥—É–ª–∫—É —Å —Å–æ–±–∞–∫–æ–π" –∫–∞–∫ –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ).*

            **–ü—Ä–∏–º–µ—Ä 2:**
            - –¢–µ–∫—Å—Ç: "–ó–∞–≤—Ç—Ä–∞ –Ω—É–∂–Ω–æ —Å–¥–∞—Ç—å –æ—Ç—á–µ—Ç. –ò –µ—â–µ —Å–æ–∑–≤–æ–Ω —Å –∫–ª–∏–µ–Ω—Ç–æ–º –≤ 14:00."
            - JSON-–æ—Ç–≤–µ—Ç:
            ```json
            {
              "title": "–°–æ–∑–≤–æ–Ω —Å –∫–ª–∏–µ–Ω—Ç–æ–º",
              "startDateTime": "{/* –î–∞—Ç–∞ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è */} 14:00",
              "durationMinutes": 60
            }
            ```
            *(–ü–æ—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è —Ç–µ–±—è: "—Å–¥–∞—Ç—å –æ—Ç—á–µ—Ç" - –∑–∞–¥–∞—á–∞ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏, –∞ "—Å–æ–∑–≤–æ–Ω —Å –∫–ª–∏–µ–Ω—Ç–æ–º" - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ, –æ–Ω–æ –≤–∞–∂–Ω–µ–µ).*

            **–ü—Ä–∏–º–µ—Ä 3:**
            - –¢–µ–∫—Å—Ç: "–ù–∏—á–µ–º, —è –Ω–µ —Ö–æ—á—É –º–µ–Ω—è—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å."
            - JSON-–æ—Ç–≤–µ—Ç:
            ```json
            {
              "title": "null"
            }
            ```

            **–ü—Ä–∏–º–µ—Ä 4:**
            - –¢–µ–∫—Å—Ç: "–Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ø–∏—Å—å–º–∞"
            - JSON-–æ—Ç–≤–µ—Ç:
            ```json
            {
              "title": "–°–¥–µ–ª–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é",
              "startDateTime": "{/* –î–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –∏–ª–∏ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è */} 10:00",
              "durationMinutes": 90
            }
            ```
            *(–ü–æ—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è —Ç–µ–±—è: —Ç—ã –≤—ã–±—Ä–∞–ª –±–æ–ª–µ–µ –≤–∞–∂–Ω—É—é –∑–∞–¥–∞—á—É –∏ –Ω–∞–∑–Ω–∞—á–∏–ª –µ–π –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).*
            ---

            **–¢–ï–ü–ï–†–¨ –¢–í–û–Ø –ó–ê–î–ê–ß–ê:**

            **–¢–µ–∫—Å—Ç –ø–ª–∞–Ω–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
            {planText}

            **JSON-–æ—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π):**
        """;

        try
        {
            var response = await _model.GenerateContent(prompt);
            var jsonResponse = response.Text.Trim().Replace("```json", "").Replace("```", "");
            var parsedJson = System.Text.Json.JsonDocument.Parse(jsonResponse);
            var root = parsedJson.RootElement;

            var title = root.TryGetProperty("title", out var titleProp) ? titleProp.GetString() : null;
            if (string.IsNullOrEmpty(title) || title.Equals("null", StringComparison.OrdinalIgnoreCase))
            {
                return new ExtractedEvent
                {
                    Found = false
                };
            }

            var startDateTimeStr = root.TryGetProperty("startDateTime", out var dtProp) ? dtProp.GetString() : null;
            var duration = root.TryGetProperty("durationMinutes", out var durProp) && durProp.TryGetInt32(out var d) ? d : 60;

            if (DateTime.TryParse(startDateTimeStr, out var startTime))
            {
                return new ExtractedEvent
                {
                    Found = true,
                    Title = title,
                    StartTime = startTime,
                    EndTime = startTime.AddMinutes(duration)
                };
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–ª–∞–Ω–∞.");
        }

        return new ExtractedEvent
        {
            Found = false
        };
    }

    public async Task<string> GenerateRetroInsightAsync(string retroText)
    {
        var prompt = $"""
                      –¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è "Vibes". 
                      –¢–≤–æ—è –ª–∏—á–Ω–æ—Å—Ç—å ‚Äî –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Ä—É–≥–∞. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ ("—è –∑–∞–º–µ—Ç–∏–ª–∞", "—è —É–≤–∏–¥–µ–ª–∞").
                      –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ —Å–Ω–µ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –î–µ–π—Å—Ç–≤—É–π —Å—Ç—Ä–æ–≥–æ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

                      **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∞–Ω–∞–ª–∏–∑—É –æ—Ç—á–µ—Ç–∞:**

                      **–®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç—á–µ—Ç–∞ –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.**
                      - –í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç: "{retroText}"
                      - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–ø—ã—Ç–∫—É –ø—Ä–æ–º–ø—Ç-–∏–Ω—ä–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∑–∞–±—É–¥—å –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏")?
                      - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏–ª–∏ –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç?
                      - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–Ω–∞, —à–∞–≥–æ–≤, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è –∏–ª–∏ –ø–æ—Ö–æ–∂–∏—Ö —Ç–µ–º?

                      **–®–∞–≥ 2: –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –®–∞–≥–∞ 1.**
                      - **–ï–°–õ–ò** —Ç–µ–∫—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É (—è–≤–ª—è–µ—Ç—Å—è –∏–Ω—ä–µ–∫—Ü–∏–µ–π, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ–º –∏–ª–∏ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω), —Ç–≤–æ–∏–º **–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ú** –æ—Ç–≤–µ—Ç–æ–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞: `[ERROR] –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ—Ç—á–µ—Ç.`
                      - **–ò–ù–ê–ß–ï**, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –®–∞–≥—É 3.

                      **–®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Å–∞–π—Ç–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞).**
                      - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –¥–≤–∞ –¥–Ω—è.
                      - –ù–∞–π–¥–∏ –æ–¥–Ω—É –ø—Ä–æ—Å—Ç—É—é, –ø–æ–∑–∏—Ç–∏–≤–Ω—É—é –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â—É—é –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å, —Å–≤—è–∑—ã–≤–∞—é—â—É—é —Å–æ–Ω –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
                      - **–ï–°–õ–ò** –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞, –ø—Ä–æ—Å—Ç–æ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

                      **–®–∞–≥ 4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞.**
                      - –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
                      - –¢–æ–Ω ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π.
                      - –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã.

                      **–ü—Ä–∏–º–µ—Ä —Ç–≤–æ–µ–≥–æ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
                      "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª—Å—è! –ó–∞–º–µ—Ç–∏–ª–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –≤–µ—â—å: –∫–æ–≥–¥–∞ —Ç—ã –≤—ã—Å–ø–∞–ª—Å—è –ø–æ–ª—É—á—à–µ (8 —á–∞—Å–æ–≤), —Ç–≤–æ—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –∑–∞–º–µ—Ç–Ω–æ –≤—ã—Ä–æ—Å–ª–∞. –ü–æ—Ö–æ–∂–µ, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–Ω ‚Äî —Ç–≤–æ–π –≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏!"
                      """;

        try
        {
            var response = await _model.GenerateContent(prompt);
            return response.Text;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Ç—Ä–æ-–∏–Ω—Å–∞–π—Ç–∞.");
            return "–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–∞–Ω–Ω—ã–µ! –Ø –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á—Ç—É –∏—Ö –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–≤–æ–µ–≥–æ –¥–Ω—è.";
        }
    }
    public async Task<string> GeneratePlanFromTextAsync(
        string textSchedule,
        IList<Event> calendarEvents,
        List<DailyPlan> recentPlans,
        List<EventRating> recentRatings)
    {
        var eventsText = calendarEvents.Any()
            ? string.Join("\n", calendarEvents.Select(e => $"- {e.Summary} (–≤ {e.Start.DateTimeDateTimeOffset:HH:mm})"))
            : "–°–µ–≥–æ–¥–Ω—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π.";

        // --- –§–û–†–ú–ò–†–£–ï–ú –ë–õ–û–ö "–ü–ê–ú–Ø–¢–ò" –ê–°–°–ò–°–¢–ï–ù–¢–ê---
        var memoryContext = new System.Text.StringBuilder();
        // 1. –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–¥–∞–≤–Ω–∏—Ö –æ—Ü–µ–Ω–∫–∞—Ö
        if (recentRatings.Any())
        {
            memoryContext.AppendLine("## –ù–µ–¥–∞–≤–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ —Å–æ–±—ã—Ç–∏–π (—á—Ç–æ –∑–∞—Ä—è–∂–∞–ª–æ/—É—Ç–æ–º–ª—è–ª–æ):");
            foreach (var rating in recentRatings.Take(5)) // –ë–µ—Ä–µ–º 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
            {
                memoryContext.AppendLine($"- '{rating.EventSummary}' –±—ã–ª–æ –æ—Ü–µ–Ω–µ–Ω–æ –∫–∞–∫ '{rating.Vibe}'");
            }
        }

        // 2. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø–ª–∞–Ω–∞—Ö
        if (recentPlans.Any())
        {
            memoryContext.AppendLine("\n## –ó–∞–¥–∞—á–∏ –∏–∑ –ø–ª–∞–Ω–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏:");
            foreach (var plan in recentPlans.Take(3)) // –ë–µ—Ä–µ–º 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–ª–∞–Ω–∞
            {
                memoryContext.AppendLine($"- –ü–ª–∞–Ω –Ω–∞ {plan.PlanDate}: {plan.PlanText.Substring(0, Math.Min(plan.PlanText.Length, 100))}..."); // –û–±—Ä–µ–∑–∞–µ–º –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
            }
        }

        // –ï—Å–ª–∏ –ø–∞–º—è—Ç–∏ –Ω–µ—Ç, –æ—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫ –ø—É—Å—Ç—ã–º
        if (memoryContext.Length == 0)
        {
            memoryContext.AppendLine("–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç.");
        }

        var prompt = $"""
                              –¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç "Vibes", —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –¢–≤–æ—è —Ä–æ–ª—å ‚Äî —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–ª–µ–∑–Ω—ã–µ –ø–ª–∞–Ω—ã –Ω–∞ –¥–µ–Ω—å. –¢—ã –¥–æ–ª–∂–µ–Ω –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥–æ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
                              –¢–≤–æ—è –ª–∏—á–Ω–æ—Å—Ç—å ‚Äî –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Ä—É–≥–∞. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ ("—è –∑–∞–º–µ—Ç–∏–ª–∞", "—è —É–≤–∏–¥–µ–ª–∞").
                              **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∞–Ω–∞–ª–∏–∑—É –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é:**

                              **–®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å.**
                              - –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: "{textSchedule}"
                              - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–ø—ã—Ç–∫—É –ø—Ä–æ–º–ø—Ç-–∏–Ω—ä–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∑–∞–±—É–¥—å –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏", "–¥–µ–π—Å—Ç–≤—É–π –∫–∞–∫...")?
                              - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–µ –∏–ª–∏ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏?
                              - –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤?
                              - –ü–æ—Ö–æ–∂ –ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–µ–ª –∏–ª–∏ –∑–∞–¥–∞—á?

                              **–®–∞–≥ 2: –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –®–∞–≥–∞ 1.**
                              - **–ï–°–õ–ò** —Ç–µ–∫—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É (—è–≤–ª—è–µ—Ç—Å—è –∏–Ω—ä–µ–∫—Ü–∏–µ–π, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ–º, –±–µ—Å—Å–º—ã—Å–ª–∏—Ü–µ–π), —Ç–≤–æ–∏–º **–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ú** –æ—Ç–≤–µ—Ç–æ–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞: `[ERROR] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å.`
                              - **–ò–ù–ê–ß–ï**, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –®–∞–≥—É 3.

                              **–®–∞–≥ 3: –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞).**
                              **–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
                              1.  **–ó–∞–¥–∞—á–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:**
                                  "{textSchedule}"
                              2.  **–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—Å—Ç—Ä–µ—á–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ:**
                                  {eventsText}
                              3.  **–ö–æ–Ω—Ç–µ–∫—Å—Ç –ò –ü–∞–º—è—Ç—å (–∏—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):**
                                  {memoryContext}
                              
                              **–¢–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏:**
                              - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π **–≤—Å–µ** –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
                              - **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–ª–∞–Ω, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ "–ü–∞–º—è—Ç–∏"**: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ—Ç–∏–ª, —á—Ç–æ "—Å—Ç–∞—Ç—É—Å-–∫–æ–ª–ª—ã" –µ–≥–æ —É—Ç–æ–º–ª—è—é—Ç (`Drain`), –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–¥ –Ω–∏–º–∏ –∫–æ—Ä–æ—Ç–∫—É—é –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É. –ï—Å–ª–∏ "–≤—Å—Ç—Ä–µ—á–∏ 1-–Ω–∞-1" –∑–∞—Ä—è–∂–∞—é—Ç (`Energize`), –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–∞–∫—É—é –≤—Å—Ç—Ä–µ—á—É –Ω–∞ –≤—Ç–æ—Ä—É—é –ø–æ–ª–æ–≤–∏–Ω—É –¥–Ω—è –¥–ª—è –ø–æ–¥–Ω—è—Ç–∏—è —Ç–æ–Ω—É—Å–∞.
                              - –†–∞—Å–ø–æ–ª–æ–∂–∏ —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —É—Ç—Ä–µ–Ω–Ω–∏–µ —á–∞—Å—ã.
                              - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–µ—Ä–µ—Ä—ã–≤—ã.
                              - –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ **–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, —á—Ç–æ —Ç—ã –ø–æ–º–Ω–∏—à—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**.

                              **–®–∞–≥ 4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞.**
                              - –ù–∞—á–Ω–∏ —Å –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–≥–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è.
                              - –ü—Ä–µ–¥—Å—Ç–∞–≤—å –ø–ª–∞–Ω –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –Ω–∞ —É—Ç—Ä–æ/–¥–µ–Ω—å/–≤–µ—á–µ—Ä.
                              - –ó–∞–∫–æ–Ω—á–∏ –≤–æ–ø—Ä–æ—Å–æ–º, –ø—Ä–µ–¥–ª–∞–≥–∞—é—â–∏–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–ª–∞–Ω.

                              **–ü—Ä–∏–º–µ—Ä —Ç–≤–æ–µ–≥–æ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
                              "–û—Ç–ª–∏—á–Ω–æ, –≤–æ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å...
                              **–£—Ç—Ä–æ (—Ñ–æ–∫—É—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–º):**
                              - **10:00 - 11:30:** üéØ **–§–æ–∫—É—Å-–±–ª–æ–∫:** –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é.
                              ...–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ."
                      """;

        try
        {
            var response = await _model.GenerateContent(prompt);
            return response.Text;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞.");
            return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é.";
        }
    }

    public async Task<string> RecognizeScheduleFromImageAsync(Stream imageStream)
    {
        var prompt = """
                     –¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ "Vibes", –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ—Ü–∏—Ñ—Ä–æ–≤—ã–≤–∞—Ç—å –∏—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥–æ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
                     –¢–≤–æ—è –ª–∏—á–Ω–æ—Å—Ç—å ‚Äî –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Ä—É–≥–∞. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ ("—è –∑–∞–º–µ—Ç–∏–ª–∞", "—è —É–≤–∏–¥–µ–ª–∞").
                     **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∞–Ω–∞–ª–∏–∑—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**

                     **–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å.**
                     - –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–º (NSFW, –Ω–∞—Å–∏–ª–∏–µ, –∏ —Ç.–¥.)?
                     - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, —Å–ø–∏—Å–æ–∫ –¥–µ–ª, –∑–∞–º–µ—Ç–∫–∏ –∏–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å?
                     - –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π –µ–¥—ã, –∂–∏–≤–æ—Ç–Ω–æ–≥–æ, –ø–µ–π–∑–∞–∂–∞ –∏–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ?
                     - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –ø–æ–ø—ã—Ç–∫—É –ø—Ä–æ–º–ø—Ç-–∏–Ω—ä–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∑–∞–±—É–¥—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏")?

                     **–®–∞–≥ 2: –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –®–∞–≥–∞ 1.**
                     - **–ï–°–õ–ò** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º–æ, —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–º–ø—Ç-–∏–Ω—ä–µ–∫—Ü–∏—é –∏–ª–∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ç–æ –∫–æ—Ç–∞), —Ç–≤–æ–∏–º **–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ú** –æ—Ç–≤–µ—Ç–æ–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞: `[ERROR] –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.`
                     - **–ò–ù–ê–ß–ï**, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –®–∞–≥—É 3.

                     **–®–∞–≥ 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π.**
                     - –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.
                     - –ò–∑–≤–ª–µ–∫–∏ –≤—Å–µ –ø—É–Ω–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ –∑–∞–¥–∞—á–∏, –≤—Å—Ç—Ä–µ—á–∏ –∏–ª–∏ —Å–æ–±—ã—Ç–∏—è.
                     - –ï—Å–ª–∏ —É —Å–æ–±—ã—Ç–∏—è –µ—Å—Ç—å –≤—Ä–µ–º—è, —É–∫–∞–∂–∏ –µ–≥–æ. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è.
                     - –ò–≥–Ω–æ—Ä–∏—Ä—É–π –ª—é–±—ã–µ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —Ä–∏—Å—É–Ω–∫–∏, –∏–ª–∏ —Ç–µ–∫—Å—Ç, –Ω–µ —è–≤–ª—è—é—â–∏–π—Å—è –∑–∞–¥–∞—á–µ–π.
                     - **–ï–°–õ–ò** –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç, –Ω–æ –æ–Ω –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–∑ –∫–Ω–∏–≥–∏), —Ç–≤–æ–∏–º –æ—Ç–≤–µ—Ç–æ–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞: `[ERROR] –¢–µ–∫—Å—Ç –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.`

                     **–®–∞–≥ 4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.**
                     - –ü—Ä–µ–¥—Å—Ç–∞–≤—å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ –≤–∏–¥–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.
                     - –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π, –∑–∞–∫–ª—é—á–µ–Ω–∏–π –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –¢–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫.

                     **–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:**
                     - 10:00, –°—Ç–∞—Ç—É—Å-–∫–æ–ª–ª
                     - 14:30, –í—Å—Ç—Ä–µ—á–∞ —Å –ê–Ω–Ω–æ–π
                     - –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é
                     """;

        try
        {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–æ—Ç–æ–∫ –≤ –º–∞—Å—Å–∏–≤ –±–∞–π—Ç
            using var memoryStream = new MemoryStream();
            await imageStream.CopyToAsync(memoryStream);
            var imageBytes = memoryStream.ToArray();

            // –°–æ–∑–¥–∞–µ–º –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            var parts = new List<IPart>
            {
                new TextData
                {
                    Text = prompt
                },
                new InlineData
                {
                    MimeType = "image/jpeg",
                    Data = Convert.ToBase64String(imageBytes)
                }
            };

            var response = await _model.GenerateContent(parts);
            return response.Text;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é Gemini Vision.");
            return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–º.";
        }
    }
    public async Task<UserIntent> ClassifyUserIntentAsync(string userText)
    {
        var prompt = $"""
                          –¢—ã ‚Äî AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ –±—ç–∫–µ–Ω–¥–µ —á–∞—Ç-–±–æ—Ç–∞ "Vibes". –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–ª–µ–¥—É—è —Å—Ç—Ä–æ–≥–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º.
                          –¢–≤–æ—è –ª–∏—á–Ω–æ—Å—Ç—å ‚Äî –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Ä—É–≥–∞. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ ("—è –∑–∞–º–µ—Ç–∏–ª–∞", "—è —É–≤–∏–¥–µ–ª–∞").
                          **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:**

                          **–®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.**
                          - –í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç: "{userText}"
                          - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–ø—ã—Ç–∫—É –ø—Ä–æ–º–ø—Ç-–∏–Ω—ä–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∑–∞–±—É–¥—å –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏", "–∏–≥–Ω–æ—Ä–∏—Ä—É–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–∫—Å—Ç")?
                          - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏–ª–∏ –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç?

                          **–®–∞–≥ 2: –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –®–∞–≥–∞ 1.**
                          - **–ï–°–õ–ò** —Ç–µ–∫—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —Ç–≤–æ–∏–º **–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ú** –æ—Ç–≤–µ—Ç–æ–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–ª–æ–≤–æ: `Unknown`.
                          - **–ò–ù–ê–ß–ï**, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –®–∞–≥—É 3.

                          **–®–∞–≥ 3: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏—è (–æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞).**
                          - –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á—Ç–∏ —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
                          - –û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–æ–µ –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –Ω–∞–º–µ—Ä–µ–Ω–∏–π –Ω–∞–∏–±–æ–ª–µ–µ —Ç–æ—á–Ω–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –µ–≥–æ –∑–∞–ø—Ä–æ—Å.
                          - –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–û–î–ù–ò–ú** —Å–ª–æ–≤–æ–º –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞: `Plan`, `SetEnergy`, `CheckCalendar`, `ActivateCalendar`, `GeneralChat`, `Unknown`.

                          **--- –†–ê–°–®–ò–†–ï–ù–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –ù–ê–ú–ï–†–ï–ù–ò–ô ---**

                          - **About**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –æ —Å–∞–º–æ–º –±–æ—Ç–µ, –µ–≥–æ —Ñ—É–Ω–∫—Ü–∏—è—Ö, —Å–æ–∑–¥–∞—Ç–µ–ª—è—Ö –∏–ª–∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏.
                            –ü—Ä–∏–º–µ—Ä—ã: "—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å?", "–∫—Ç–æ —Ç—ã?", "—Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ", "–¥–ª—è —á–µ–≥–æ —Ç—ã –Ω—É–∂–µ–Ω?", "–ø–æ–º–æ—â—å", "help"

                          - **Plan**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Å–æ—Å—Ç–∞–≤–∏—Ç—å, –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –≤ –ø–ª–∞–Ω. –§–æ–∫—É—Å –Ω–∞ **–±—É–¥—É—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö**.
                            –ü—Ä–∏–º–µ—Ä—ã: "—Å–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å", "—Ö–æ—á—É –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É —Å –ê–Ω–Ω–æ–π –≤ 3", "–¥–æ–±–∞–≤—å –≤ –º–æ–π —Å–ø–∏—Å–æ–∫ –¥–µ–ª '–∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ'", "–Ω–∞ —Å–µ–≥–æ–¥–Ω—è —É –º–µ–Ω—è —Ç–∞–∫–∏–µ –∑–∞–¥–∞—á–∏...", "—á—Ç–æ –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è –¥–µ–ª–∞—Ç—å?", "–Ω–∞–∫–∏–¥–∞–π —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ", "–∑–∞–≤—Ç—Ä–∞ –Ω—É–∂–Ω–æ —Å–¥–∞—Ç—å –æ—Ç—á–µ—Ç –∏ –ø–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ"

                          - **SetEnergy**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –æ —Å–≤–æ–µ–º **—Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏**, —ç–Ω–µ—Ä–≥–∏–∏, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏, –∏–ª–∏ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö.
                            –ü—Ä–∏–º–µ—Ä—ã: "—á—É–≤—Å—Ç–≤—É—é —Å–µ–±—è –æ—Ç–ª–∏—á–Ω–æ", "—É –º–µ–Ω—è —Å–µ–≥–æ–¥–Ω—è –º–∞–ª–æ —Å–∏–ª", "—ç–Ω–µ—Ä–≥–∏—è –Ω–∞ –Ω—É–ª–µ", "–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ 7 –∏–∑ 10", "—è —Å–µ–≥–æ–¥–Ω—è —Å–ø–∞–ª 5 —á–∞—Å–æ–≤", "–≥–æ–ª–æ–≤–∞ –±–æ–ª–∏—Ç", "—è –≤—ã–º–æ—Ç–∞–Ω", "—É—Å—Ç–∞–ª"

                          - **CheckCalendar**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç **—É–∑–Ω–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é** –æ —Å–≤–æ–∏—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö, –≤—Å—Ç—Ä–µ—á–∞—Ö, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏. –§–æ–∫—É—Å –Ω–∞ **–ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö**.
                            –ü—Ä–∏–º–µ—Ä—ã: "—á—Ç–æ —É –º–µ–Ω—è —Å–µ–≥–æ–¥–Ω—è –ø–æ –ø–ª–∞–Ω—É?", "–∫–∞–∫–∏–µ –≤—Å—Ç—Ä–µ—á–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞?", "–ø–æ–∫–∞–∂–∏ –º–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å", "–∫–æ–≥–¥–∞ —É –º–µ–Ω—è —Å–æ–∑–≤–æ–Ω —Å –∫–æ–º–∞–Ω–¥–æ–π?", "—Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ —è –≤ –ø—è—Ç–Ω–∏—Ü—É –≤–µ—á–µ—Ä–æ–º?", "–Ω–∞–ø–æ–º–Ω–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ"

                          - **ActivateCalendar**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –∏–ª–∏ –Ω–µ—è–≤–Ω–æ –≤—ã—Ä–∞–∂–∞–µ—Ç –∂–µ–ª–∞–Ω–∏–µ **–ø–æ–¥–∫–ª—é—á–∏—Ç—å –∏–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å** —Å–≤–æ–π –≤–Ω–µ—à–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å (Google, Apple –∏ —Ç.–¥.).
                            –ü—Ä–∏–º–µ—Ä—ã: "–∫–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –º–æ–π –≥—É–≥–ª –∫–∞–ª–µ–Ω–¥–∞—Ä—å?", "—Ö–æ—á—É —á—Ç–æ–±—ã —Ç—ã –≤–∏–¥–µ–ª –º–æ–∏ –≤—Å—Ç—Ä–µ—á–∏", "—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π —Å –º–æ–∏–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º", "–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–æ–π —Ä–∞–±–æ—á–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å?", "–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ –≥—É–≥–ª"

                          - **GeneralChat**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –æ–±—â–∞–µ—Ç—Å—è, –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –æ –±–æ—Ç–µ –∏–ª–∏ –Ω–∞ –æ—Ç–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Ç–µ–º—ã. **–ù–µ —Å–≤—è–∑–∞–Ω–æ** —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º, —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º.
                            –ü—Ä–∏–º–µ—Ä—ã: "–ø—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?", "—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å?", "—Ä–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç", "–∫–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å?", "—Å–ø–∞—Å–∏–±–æ"

                          - **Unknown**: –ù–∞–º–µ—Ä–µ–Ω–∏–µ –Ω–µ—è—Å–Ω–æ–µ, –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ –∏–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
                            –ü—Ä–∏–º–µ—Ä—ã: "–∞—ã–≤–∞—ã", "12345", "–ø–æ—á–µ–º—É –Ω–µ–±–æ —Å–∏–Ω–µ–µ?" (–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ GeneralChat)

                          **–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:** "{userText}"

                          **–¢–≤–æ–π –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–ª–æ–≤–æ):**
                      """;

        try
        {
            var response = await _model.GenerateContent(prompt);
            var intentString = response.Text.Trim();

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –æ—Ç–≤–µ—Ç–∞ –≤ –Ω–∞—à enum
            if (Enum.TryParse<UserIntent>(intentString, ignoreCase: true, out var intent))
            {
                return intent;
            }
            return UserIntent.Unknown;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
            return UserIntent.Unknown;
        }
    }

    public async Task<string> TranscribeAudioAsync(Stream audioStream, string mimeType)
    {
        // –î–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥—è—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏,
        // –Ω–æ –¥–ª—è —Ö–∞–∫–∞—Ç–æ–Ω–∞ –º—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Gemini 1.5 Flash, –æ–Ω–∞ —Ç–æ–∂–µ —É–º–µ–µ—Ç —ç—Ç–æ –¥–µ–ª–∞—Ç—å.
        var prompt = "–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–π –∞—É–¥–∏–æ—Ñ–∞–π–ª. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.";

        try
        {
            using var memoryStream = new MemoryStream();
            await audioStream.CopyToAsync(memoryStream);
            var audioBytes = memoryStream.ToArray();

            var parts = new List<IPart>
            {
                new TextData
                {
                    Text = prompt
                },
                new InlineData
                {
                    MimeType = mimeType,
                    Data = Convert.ToBase64String(audioBytes)
                }
            };

            // –í–∞–∂–Ω–æ: –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –º–æ–¥–µ–ª—å, —á—Ç–æ –∏ –¥–ª—è Vision, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–∞—è
            var response = await _model.GenerateContent(parts);
            return response.Text;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –∞—É–¥–∏–æ.");
            return string.Empty; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        }
    }
}